<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Textale</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      background: #f6f7f9;
      color: #111;
    }
    header {
      padding: 16px;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 1;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    h1 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }
    .container {
      padding: 16px;
      display: grid;
      gap: 16px;
    }
    .panel {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 840px) {
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
    }
    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      font-size: 16px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-sizing: border-box;
    }
    label {
      font-size: 12px;
      color: #374151;
      display: block;
      margin-bottom: 6px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    input[type="number"], input[type="text"], input[type="color"], select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      background: #fff;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #111827;
      background: #111827;
      color: #fff;
      font-weight: 600;
    }
    button.secondary {
      background: #fff;
      color: #111827;
    }
    .preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    .card img {
      display: block;
      width: 100%;
      height: auto;
      background: #fff;
    }
    .card .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      font-size: 12px;
    }
    .note {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
  <meta name="description" content="長文テキストを指定サイズの画像に自動分割。ダブル改行でページ送り。スマホからそのまま保存できます。" />
</head>
<body>
  <header>
    <h1>テキスト→画像 分割ツール"Textale"</h1>
    <div class="note">ダブル改行で次の画像に繰り下げ。自動折り返し・高さあふれでページ分割。PNG保存対応。</div>
  </header>

  <main class="container">
    <section class="panel grid">
      <div>
        <label for="inputText">テキスト</label>
        <textarea id="inputText" placeholder="ここに小説や長文を貼り付けてください。\n\nダブル改行で次の画像へ送られます。\n\n例：\n一枚目の内容...\nまだ一枚目...\n\n二枚目の先頭...\n..."></textarea>
      </div>

      <div class="grid">
        <div class="row">
          <div>
            <label for="width">画像の幅 (px)</label>
            <input id="width" type="number" inputmode="numeric" value="1080" min="300" max="4096" />
          </div>
          <div>
            <label for="height">画像の高さ (px)</label>
            <input id="height" type="number" inputmode="numeric" value="1920" min="300" max="8192" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fontSize">文字サイズ (px)</label>
            <input id="fontSize" type="number" inputmode="numeric" value="42" min="14" max="128" />
          </div>
          <div>
            <label for="lineHeight">行間 (倍)</label>
            <input id="lineHeight" type="number" inputmode="decimal" step="0.05" value="1.6" min="1.0" max="2.5" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="padding">余白 (px)</label>
            <input id="padding" type="number" inputmode="numeric" value="64" min="0" max="400" />
          </div>
          <div>
            <label for="fontFamily">フォント</label>
            <select id="fontFamily">
              <option value="-apple-system, system-ui, 'Noto Sans JP', 'Hiragino Sans', Meiryo, sans-serif">San-Serif (推奨)</option>
              <option value="'Noto Serif JP', 'Hiragino Mincho ProN', 'Yu Mincho', serif">Serif (明朝)</option>
              <option value="'M PLUS 1p', 'Noto Sans JP', sans-serif">M PLUS 1p</option>
              <option value="'Yu Gothic', 'Noto Sans JP', sans-serif">游ゴシック</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="textColor">文字色</label>
            <input id="textColor" type="color" value="#111111" />
          </div>
          <div>
            <label for="bgColor">背景色</label>
            <input id="bgColor" type="color" value="#ffffff" />
          </div>
        </div>

        <div class="actions">
          <button id="btnGenerate">画像を作成</button>
          <button id="btnClear" class="secondary">リセット</button>
        </div>
        <div class="note">文字サイズは全画像で一定。2行の改行 (空行1つ) で次の画像に繰り下がります。</div>
      </div>
    </section>

    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;">
        <div><strong>プレビュー</strong></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="btnShareX" class="secondary" style="display:flex;align-items:center;gap:4px;padding:6px 10px;font-size:14px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3L7 21"/><path d="M4 7h16"/><path d="M4 17h16"/></svg>
            <span>Xでシェア</span>
          </button>
          <div class="note">各画像をタップ長押しで保存 (またはボタンで保存)。</div>
        </div>
      </div>
      <div id="preview" class="preview"></div>
    </section>
  </main>

  <script>
    // メイン処理
    const el = (id) => document.getElementById(id);

    const inputText = el('inputText');
    const inputWidth = el('width');
    const inputHeight = el('height');
    const inputFontSize = el('fontSize');
    const inputLineHeight = el('lineHeight');
    const inputPadding = el('padding');
    const inputFontFamily = el('fontFamily');
    const inputTextColor = el('textColor');
    const inputBgColor = el('bgColor');
    const btnGenerate = el('btnGenerate');
    const btnClear = el('btnClear');
    const preview = el('preview');

  btnGenerate.addEventListener('click', () => {
    // X（旧Twitter）シェアボタン
    const btnShareX = el('btnShareX');
    if (btnShareX) {
      btnShareX.addEventListener('click', () => {
        const shareText = 'テキスト→画像 分割ツール"Textale" https://shayashida.github.io/Textale/';
        const xUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
        const w = 600, h = 480;
        const left = window.screenX + (window.outerWidth - w) / 2;
        const top = window.screenY + (window.outerHeight - h) / 2;
        window.open(xUrl, 'shareX', `width=${w},height=${h},left=${left},top=${top},menubar=no,toolbar=no,status=no,scrollbars=yes`);
      });
    }
      const text = (inputText.value || '').replace(/\r\n/g, '\n');
      if (!text.trim()) {
        preview.innerHTML = '<div class="note">テキストを入力してください。</div>';
        return;
      }
      const width = clamp(parseInt(inputWidth.value || '1080', 10), 300, 4096);
      const height = clamp(parseInt(inputHeight.value || '1920', 10), 300, 8192);
      const fontSize = clamp(parseInt(inputFontSize.value || '42', 10), 10, 256);
      const lineHeightMul = clamp(parseFloat(inputLineHeight.value || '1.6'), 1.0, 3.0);
      const padding = clamp(parseInt(inputPadding.value || '64', 10), 0, Math.floor(Math.min(width, height) / 2));
      const fontFamily = inputFontFamily.value || "-apple-system, system-ui, 'Noto Sans JP', 'Hiragino Sans', Meiryo, sans-serif";
      const textColor = inputTextColor.value || '#111111';
      const bgColor = inputBgColor.value || '#ffffff';

      const pages = textToImages({ text, width, height, fontSize, lineHeightMul, padding, fontFamily, textColor, bgColor });
      renderPreview(pages);
    });

    btnClear.addEventListener('click', () => {
      inputText.value = '';
      preview.innerHTML = '';
    });

    function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }

    function textToImages(options) {
      const { text, width, height, fontSize, lineHeightMul, padding, fontFamily, textColor, bgColor } = options;
      const lineHeight = Math.round(fontSize * lineHeightMul);
      const maxTextWidth = Math.max(0, width - padding * 2);

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.fillStyle = textColor;
      ctx.font = `${fontSize}px ${fontFamily}`;

      function drawBackground() {
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = textColor;
      }

      // ページ管理
      const dataUrls = [];
      let cursorY = padding;
      let hasContentOnPage = false;

      function commitPageIfHasContent() {
        if (!hasContentOnPage) return;
        // 既存キャンバスをエクスポート
        dataUrls.push(canvas.toDataURL('image/png'));
        // 新しいページを準備
        drawBackground();
        cursorY = padding;
        hasContentOnPage = false;
      }

      // 初期背景
      drawBackground();

      // ダブル改行でチャンク分割 (空行1つでページ送り)
      const chunks = text.split(/\n\s*\n/g);
      for (let c = 0; c < chunks.length; c++) {
        const chunk = chunks[c];
        const lines = wrapToLines(chunk, ctx, maxTextWidth);
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (cursorY + lineHeight > height - padding) {
            commitPageIfHasContent();
          }
          // 描画
          if (line === '') {
            // 空行は高さだけ進める
            cursorY += lineHeight;
          } else {
            ctx.fillText(line, padding, cursorY);
            cursorY += lineHeight;
            hasContentOnPage = true;
          }
        }
        // チャンク末尾でページ送り (ダブル改行の仕様)
        commitPageIfHasContent();
      }

      // 末尾が描画されたがコミットされていない場合はコミット
      commitPageIfHasContent();

      return dataUrls;
    }

    // 自動折り返し: 日本語は連続文字、英数はスペース優先で折り返し
    function wrapToLines(text, ctx, maxWidth) {
      const result = [];
      const paragraphs = text.split('\n');
      for (let p = 0; p < paragraphs.length; p++) {
        const para = paragraphs[p];
        if (para.length === 0) {
          result.push('');
          continue;
        }
        let line = '';
        for (let i = 0; i < para.length; i++) {
          const ch = para[i];
          const test = line + ch;
          if (ctx.measureText(test).width <= maxWidth) {
            line = test;
            continue;
          }
          if (line.length === 0) {
            // 1文字でも超える場合は強制改行
            result.push(ch);
            line = '';
            continue;
          }
          const lastSpace = line.lastIndexOf(' ');
          if (lastSpace > 0) {
            result.push(line.slice(0, lastSpace));
            line = line.slice(lastSpace + 1) + ch;
          } else {
            result.push(line);
            line = ch;
          }
        }
        if (line.length > 0) result.push(line);
      }
      return result;
    }

    function renderPreview(urls) {
      preview.innerHTML = '';
      if (!urls || urls.length === 0) {
        preview.innerHTML = '<div class="note">画像はまだありません。</div>';
        return;
      }
      urls.forEach((url, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = `画像 ${idx + 1}`;
        img.src = url;

        const footer = document.createElement('div');
        footer.className = 'card-footer';
        const label = document.createElement('div');
        label.textContent = `画像 ${idx + 1}`;
        const actions = document.createElement('div');
        const a = document.createElement('a');
        a.textContent = '保存';
        a.href = url;
        a.download = `text-image-${idx + 1}.png`;
        a.className = 'secondary button-link';
        actions.appendChild(a);
        footer.appendChild(label);
        footer.appendChild(actions);

        card.appendChild(img);
        card.appendChild(footer);
        preview.appendChild(card);
      });
    }
  </script>
</body>
</html>


